## 2PC(两阶段提交协议)

### 理论基础
两阶段提交是在分布式系统下，保证所有节点在进行事务提交时能够保持一致性的一种算法。

在分布式系统中，每个节点都可以知道自己的操作是成功或失败的，但不知道别的节点操作是否成功。

当一个事务跨越几个节点时，为了保证ACID特性，需要引入一个**协调者**来协调所有节点（**参与者**）的操作结果，并最终指示这些节点是否要真正提交操作。

> 简单的思路就是参与者将操作结果反馈给协调者，协调者根据所有参与者的反馈结果决定是否要真正提交操作或者是回滚操作。

两阶段提交协议将分布式事务分为两个阶段：**准备阶段**和**提交阶段**。

**1. 准备阶段** 
   
    1.1 协调者询问所有的参与者是否能够成功执行事务。 
   
    1.2 参与者开始事务，将执行结果反馈给协调者，但不提交事务。
**2. 提交阶段**

    2.1 协调者根据所有参与者的反馈结果决定是要发起事务提交或事务回滚的通知。 
   
    2.2 参与者提交事务/回滚事务，释放锁，并向协调者反馈结果。
- **所有参与者都成功执行事务**
![2PC](/images/2PC_success.png)
  
- **一个或多个参与者未成功执行事务，或在约定时间内未返回结果**
![2PC](/images/2PC_fail.png)

优点: 思路简单，算法易实现

缺点：单点问题、阻塞导致的性能问题。
1. 单点问题
   
    从上面可以看出在整个两阶段提交的过程中，协调者是扮演着举足轻重的角色，一旦协调者挂了，那么整个过程就无法正常执行，如果在第二阶段中，协调者不能发出提交事务或回滚事务的通知，则所有参与者将一直阻塞，导致数据库集群不能提供服务。

2. 阻塞问题
   
   两阶段提交执行的过程中，参与者必须阻塞等待协调者的通知，在这期间不能去执行别的操作，导致性能很低。

### XA
XA规范是X/Open组织关于分布式事务处理的规范。
规范描述了全局的事务管理器（TM）和局部的资源管理器(RM)之间的接口。
该规范的目的是允许多个资源在同一事务中访问，这样可以使ACID特性在跨应用时也是有效的。
XA使用两阶段提交来保证所有资源的同时提交或回滚事务。

事务管理器：事务协调方，管理全局事务和分配XID（事务唯一标识）,监控事务的执行进度，负责事务的提交和回滚、失败恢复。

资源管理器：根据事务管理器的命令进行操作，实际执行者，管理本地事务。

XA实现分布式原理：
![XA](/images/XA.png)

**第一阶段**

    1.1 事务管理器询问所有的资源管理器是否能够成功执行事务。 
   
    1.2 所有的资源管理器准备开始事务并锁住需要的资源，将执行结果反馈给协调者，但不提交事务，此时进入就绪状态。
**第二阶段**

    2.1 事务管理器根据所有资源管理器的反馈结果决定是要发起事务提交或事务回滚的通知。 
   
    2.2 所有资源管理器提交事务/回滚事务，释放锁，并向事务管理器反馈结果。
### Senta AT模式

Senta AT模式是基于两阶段提交协议进行设计的。

前提：
- 基于支持本地ACID事务的关系型数据库（这个也是两阶段提交的前提）。
- Java应用，通过JDBC访问数据库。

## 3PC