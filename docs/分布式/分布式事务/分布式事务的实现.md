## 2PC(两阶段提交协议)

### 理论基础

两阶段提交是在分布式系统下，保证所有节点在进行事务提交时能够保持一致性的一种算法。

在分布式系统中，每个节点都可以知道自己的操作是成功或失败的，但不知道别的节点操作是否成功。

当一个事务跨越几个节点时，为了保证ACID特性，需要引入一个**协调者**来协调所有节点（**参与者**）的操作结果，并最终指示这些节点是否要真正提交操作。

> 简单的思路就是参与者将操作结果反馈给协调者，协调者根据所有参与者的反馈结果决定是否要真正提交操作或者是回滚操作。

两阶段提交协议将分布式事务分为两个阶段：**准备阶段**和**提交阶段**。

**1. 准备阶段**

    1.1 协调者询问所有的参与者是否能够成功执行事务。 
   
    1.2 参与者开始事务，将执行结果反馈给协调者，但不提交事务。

**2. 提交阶段**

    2.1 协调者根据所有参与者的反馈结果决定是要发起事务提交或事务回滚的通知。 
   
    2.2 参与者提交事务/回滚事务，释放锁，并向协调者反馈结果。

- **所有参与者都成功执行事务**
  ![2PC](/images/2PC_success.png)

- **一个或多个参与者未成功执行事务，或在约定时间内未返回结果**
  ![2PC](/images/2PC_fail.png)

优点: 思路简单，算法易实现

缺点：单点问题、阻塞导致的性能问题。

1. 单点问题

   从上面可以看出在整个两阶段提交的过程中，协调者是扮演着举足轻重的角色，一旦协调者挂了，那么整个过程就无法正常执行，如果在第二阶段中，协调者不能发出提交事务或回滚事务的通知，则所有参与者将一直阻塞，导致数据库集群不能提供服务。

2. 阻塞问题

   两阶段提交执行的过程中，参与者必须阻塞等待协调者的通知，在这期间不能去执行别的操作，导致性能很低。

### XA

XA规范是X/Open组织关于分布式事务处理的规范。 规范描述了全局的事务管理器（TM）和局部的资源管理器(RM)之间的接口。 该规范的目的是允许多个资源在同一事务中访问，这样可以使ACID特性在跨应用时也是有效的。
XA使用两阶段提交来保证所有资源的同时提交或回滚事务。

事务管理器：事务协调方，管理全局事务和分配XID（事务唯一标识）,监控事务的执行进度，负责事务的提交和回滚、失败恢复。

资源管理器：根据事务管理器的命令进行操作，实际执行者，管理本地事务。

XA实现分布式原理：
![XA](/images/XA.png)

**第一阶段**

    1.1 事务管理器询问所有的资源管理器是否能够成功执行事务。 
   
    1.2 所有的资源管理器准备开始事务并锁住需要的资源，将执行结果反馈给协调者，但不提交事务，此时进入就绪状态。

**第二阶段**

    2.1 事务管理器根据所有资源管理器的反馈结果决定是要发起事务提交或事务回滚的通知。 
   
    2.2 所有资源管理器提交事务/回滚事务，释放锁，并向事务管理器反馈结果。

### Senta AT模式

Senta AT模式是基于两阶段提交协议进行设计的。

#### 前提：

- 基于支持本地ACID事务的关系型数据库（这个也是两阶段提交的前提）。
- Java应用，通过JDBC访问数据库。

#### AT模式机制：

第一阶段：业务数据和回滚日志记录在同一个本地事务中提交，释放本地资源锁和连接资源。

1. 解析SQL: 得到SQL的类型，表，条件等信息。
1. 查询前镜像：根据解析SQL的信息，构造查询语句，定位到查询的数据。
1. 执行业务SQL
1. 查询后镜像：根据前镜像的结果，通过主键定位数据。
1. 插入回滚数据: 把前后镜像和业务SQL组成一条回滚日志记录，插入到UNDO_LOG表中。
1. 提交前，先向TC申请分支事务和该主键记录的全局锁。
1. 本地事务提交：业务数据的更新和回滚日志记录一起提交。
1. 将本地事务提交结果上报给TC。

第二阶段: 异步提交事务。通过第一阶段的回滚日志进行反向补偿。

二阶段回滚：

1. 收到TC的分支回滚请求，开启一个本地事务。
1. 通过XID和BranchID查找到对于的UNDO_LOG记录。
1. 数据校验，拿到UNDO_LOG记录后，查看比较镜像后记录和现在的记录是否一样，如果不同，则说明数据被当前全局事务之外的动作做了修改。这样情况根据配置策略来进行处理。
1. 更加UNDO_LOG中的前镜像和业务执行SQL生成回滚语句并执行。
1. 提交本地事务。并把本地事务执行结果上报给TC。

二阶段提交：
1. 收到TC的分支提交请求，把请求放入一个异步任务的队列中并返回执行成功的结果给TC。
1. 异步任务阶段将异步删除UNDO_LOG记录。

#### 角色:

- TC: 事务协调者
    - 维护全局和分支事务的状态，驱动全局事务的提交或回滚。
    - Senta服务。
- TM: 事务管理器
    - 定义全局事务的范围：开始全局事务，提交或回滚全局事务。
    - @GlobalTranslational入口方法,即Business服务。
- RM：资源管理器
    - 管理分支事务处理的资源，向TC进行分支事务的注册和状态的报告。
    - 驱动分支事务的提交或回滚。
    - 被@GlobalTranslational入口方法内调用的其它微服务（Order\Storage\Account）。

![XA](/images/AT.png)

#### 详解:

- 写隔离
    - 一阶段提交事务前需要获取全局锁。
    - 获取不到会重试获取，直到超时退出。
    - 进行本地事务的回滚，并释放本地锁。

- 读隔离
    - 默认全局事务隔离级别为**读未提交**，只有当语句为**select for update**才会代理为**读已提交**。
    - 当查询预计为select for update 时，会先尝试获取全局锁，如果获取不到则释放本地锁并进行重试，直到获取全局锁成功。

### TCC模式
AT模式依赖于底层数据资源的事务支持，而TCC模式是不需要依赖于底层数据资源的事务支持的。
- 一阶段准备：调用自定义的prepare逻辑。 
- 二阶段提交：调用自定义的confirm逻辑。
- 二阶段回滚：调用自定义的cancel逻辑。

也就是说TCC模式中，需要定义三个方法Try(尝试)、Confirm(确定)、Cancel(取消)。
TCC是业务侵入性强，需要自定义处理所有的逻辑。

## 3PC