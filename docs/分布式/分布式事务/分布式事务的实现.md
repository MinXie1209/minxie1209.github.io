## 2PC(两阶段提交协议)

### 理论基础
两阶段提交是在分布式系统下，保证所有节点在进行事务提交时能够保持一致性的一种算法。

在分布式系统中，每个节点都可以知道自己的操作是成功或失败的，但不知道别的节点操作是否成功。

当一个事务跨越几个节点时，为了保证ACID特性，需要引入一个**协调者**来协调所有节点（**参与者**）的操作结果，并最终指示这些节点是否要真正提交操作。

> 简单的思路就是参与者将操作结果反馈给协调者，协调者根据所有参与者的反馈结果决定是否要真正提交操作或者是回滚操作。

两阶段提交协议将分布式事务分为两个阶段：**准备阶段**和**提交阶段**。

**1. 准备阶段** 
   
    1.1 协调者询问所有的参与者是否能够成功执行事务。 
   
    1.2 参与者开始事务，将执行结果反馈给协调者，但不提交事务。
**2. 提交阶段**

    2.1 协调者根据所有参与者的反馈结果决定是要发起事务提交或事务回滚的通知。 
   
    2.2 参与者提交事务/回滚事务，释放锁，并向协调者反馈结果。
- **所有参与者都成功执行事务**
![2PC](/images/2PC_success.png)
  
- **一个或多个参与者未成功执行事务，或在约定时间内未返回结果**
![2PC](/images/2PC_fail.png)

优点: 思路简单，算法易实现

缺点：单点问题、阻塞导致的性能问题。
1. 单点问题
   
    从上面可以看出在整个两阶段提交的过程中，协调者是扮演着举足轻重的角色，一旦协调者挂了，那么整个过程就无法正常执行，如果在第二阶段中，协调者不能发出提交事务或回滚事务的通知，则所有参与者将一直阻塞，导致数据库集群不能提供服务。

2. 阻塞问题
   
   两阶段提交执行的过程中，参与者必须阻塞等待协调者的通知，在这期间不能去执行别的操作，导致性能很低。

### XA

### Senta

## 3PC